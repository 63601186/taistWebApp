<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
</head>

<body>
    <ons-navigator swipeable id="appNavigator" page="mainPage.html"></ons-navigator>

    <template id="mainPage.html">
        <ons-page id="mainPage">
            <ons-toolbar>
                <div class="center">Smartphone Probe</div>
            </ons-toolbar>
            <ons-list>
                <ons-list-item>
                    <label class="left">URL</label>
                    <label class="center">
                        <ons-input id="server-url" placeholder="Firebase URL"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <label class="left">GPS</label>
                    <label class="right" id="gps-status">NULL</label>
                </ons-list-item>
                <ons-list-item>
                    <label class="left">Motion</label>
                    <label class="right" id="motion-status">NULL</label>
                </ons-list-item>
            </ons-list>
            <ons-button modifier="large" id="start-button" onclick="fn.startAcq()">START</ons-button>
        </ons-page>
    </template>

    <script>
        let gpsWatchId = 0;
        let accelValues = [];

        function submitFirebase(t, pos, motion) {
            let Url = document.getElementById('server-url').value;
            let Data = {
                timestamp: t,
                latitude: pos.latitude,
                longitude: pos.longitude,
                motion: motion
            };
            const Params = {
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Data),
                method: 'POST'
            };
            console.log(JSON.stringify(Data))
            fetch(Url, Params).then(data => { return data.json(); }).then(res => { console.log(res); });
        }

        function motionHandler(ev) {
            accelValues.push(ev.acceleration);                        
        }

        window.fn = {};

        window.fn.startAcq = function () {
            const status = document.getElementById('start-button').innerText;
            if (status == 'START') {
                // GPS tracking
                gpsWatchId = navigator.geolocation.watchPosition(pos => {
                    const t = new Date(pos.timestamp);
                    last_val = accelValues[accelValues.length-1];
                    document.getElementById('gps-status').innerHTML = pos.coords.latitude.toString() + ',' + pos.coords.longitude.toString();
                    document.getElementById('motion-status').innerHTML = accelValues.length.toString() + ':' + last_val.x.toFixed(2) + ',' + last_val.y.toFixed(2) + ',' + last_val.z.toFixed(2); 
                    submitFirebase(t, pos.coords, accelValues)
                    accelValues = [];
                    console.log(pos.coords, pos.timestamp, t);
                }, err => {
                    console.log(err);
                },
                options={
                    enableHighAccuracy: true,
                    timeout: 10000
                });
                try {
                    DeviceMotionEvent.requestPermission().then(response => {
                        if (response == 'granted') {
                            window.addEventListener('devicemotion', motionHandler);                            
                        }                        
                    });
                } catch {
                    window.addEventListener('devicemotion', motionHandler);
                }
                document.getElementById('start-button').innerText = 'STOP';
            } else {
                navigator.geolocation.clearWatch(gpsWatchId);
                window.removeEventListener('devicemotion', motionHandler);
                gpsWatchId = 0;
                document.getElementById('start-button').innerText = 'START';
            }
        }

        document.addEventListener('init', function (event) {
            var page = event.target;

            function showPosition(position) {
                page.querySelector('#latlng').innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude;
                const Url = 'https://supachai-taist-demo.firebaseio.com/logs.json';
                let Data = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };
                const Params = {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(Data),
                    method: 'POST'
                };
                console.log(JSON.stringify(Data));
                fetch(Url, Params).then(data => { return data.json(); }).then(res => { console.log(res); });
            }

            if (page.id === 'page1') {
                page.querySelector('#push-button').onclick = function () {
                    document.querySelector('#myNavigator').pushPage('page2.html', { data: { title: 'Page 2' } });
                };
            } else if (page.id === 'page2') {
                page.querySelector('ons-toolbar .center').innerHTML = page.data.title;
                navigator.geolocation.getCurrentPosition(showPosition);
            }
        });
    </script>
</body>

</html>
