<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
</head>

<body>
    <ons-navigator swipeable id="appNavigator" page="mainPage.html"></ons-navigator>

    <template id="mainPage.html">
        <ons-page id="mainPage">
            <ons-toolbar>
                <div class="center">Smartphone Probe</div>
            </ons-toolbar>
            <ons-list>
                <ons-list-item>
                    <label class="left">URL</label>
                    <label class="center">
                        <ons-input id="server-url" placeholder="Firebase URL"></ons-input>
                    </label>
                </ons-list-item>
                <ons-list-item>
                    <label class="left">GPS</label>
                    <label class="right" id="gps-status">NULL</label>
                </ons-list-item>
                <ons-list-item>
                    <label class="left">Motion</label>
                    <label class="right" id="motion-status">NULL</label>
                </ons-list-item>
            </ons-list>
            <ons-button modifier="large" id="start-button" onclick="fn.startAcq()">START</ons-button>
        </ons-page>
    </template>

    <script>
        let gpsWatchId = 0;
        let motionX = [];
        let motionY = [];
        let motionZ = [];

        function submitFirebase(t, pos, X, Y, Z) {
            let Url = 'https://supachai-iot-project.firebaseio.com/test.json'
            //document.getElementById('server-url').value;
            let Data = {
                timestamp: t,
                latitude: pos.latitude,
                longitude: pos.longitude,
                motionX: X,
                motionY: Y,
                motionZ: Z,
            };
            const Params = {
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Data),
                method: 'POST'
            };
            console.log(JSON.stringify(Data))
            fetch(Url, Params).then(data => { return data.json(); }).then(res => { console.log(res); });
        }

        function motionHandler(ev) {
            motionX.push(ev.acceleration.x);
            motionY.push(ev.acceleration.y);
            motionZ.push(ev.acceleration.z); 
        }

        window.fn = {};

        window.fn.startAcq = function () {
            const status = document.getElementById('start-button').innerText;
            if (status == 'START') {
                // GPS tracking
                gpsWatchId = navigator.geolocation.watchPosition(pos => {
                    const t = new Date(pos.timestamp);
                    lastX = motionX[motionX.length-1];
                    lastY = motionY[motionY.length-1];
                    lastZ = motionZ[motionZ.length-1];
                    submitFirebase(t, pos.coords, motionX, motionY, motionZ)
                    document.getElementById('gps-status').innerHTML = pos.coords.latitude.toString() + ',' + pos.coords.longitude.toString();
                    document.getElementById('motion-status').innerHTML = accelValues.length.toString() + ':' + lastX.toFixed(2) + ',' + lastY.toFixed(2) + ',' + lastZ.toFixed(2); 
                    motionX = [];
                    motionY = [];
                    motionZ = [];
                    console.log(pos.coords, pos.timestamp, t);
                }, err => {
                    console.log(err);
                },
                options={
                    enableHighAccuracy: true,
                    timeout: 10000
                });
                try {
                    DeviceMotionEvent.requestPermission().then(response => {
                        if (response == 'granted') {
                            window.addEventListener('devicemotion', motionHandler);                            
                        }                        
                    });
                } catch {
                    window.addEventListener('devicemotion', motionHandler);
                }
                document.getElementById('start-button').innerText = 'STOP';
            } else {
                navigator.geolocation.clearWatch(gpsWatchId);
                window.removeEventListener('devicemotion', motionHandler);
                gpsWatchId = 0;
                document.getElementById('start-button').innerText = 'START';
            }
        }
    </script>
</body>

</html>
